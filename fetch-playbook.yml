#!/bin/ansible-playbook

- hosts: all
  become: true
  tasks:
    - name: Add the items file by default if not passed as an argument
      set_fact:
        items_file: ./items.yml
      when: items_file is not defined

    - name: Include items from the items file
      include_vars:
        file: '{{ items_file }}'
        name: items

    - name: If the destination is defined ensure that no trailing "/" are in the path
      set_fact:
        destination: "{{ destination if destination[-1] != '/' else destination[:-1] }}"
      when: destination is defined

    - name: Add the destination by default if not passed as an argument or added as an variable in the items file.
      set_fact:
        destination: /root/fetched
      when: destination is not defined

    - name: Check if destination is created
      stat:
        path: '{{ destination }}'
      register: dest_stat
      delegate_to: localhost
      run_once: true

    - name: Create destination if not created
      file:
        path: '{{ destination }}'
        state: directory
        mode: 0644
        group: root
        owner: root
      when: dest_stat.stat.exists == false
      delegate_to: localhost
      run_once: true

    - name: Fetching the files each from the corresponding hosts only.
      synchronize:
        src: |
          {% for file in items[item] -%}
            {% if file.folder is defined -%}
              {{ '/'.join([file.path if file.path[-1] != '/' else file.path[:-1], file.folder]) }}
            {%- else -%}
              {{ file.path if file.path[-1] != '/' else file.path[:-1] }}
            {%- endif %}
            {{ " " }}
          {%- endfor %}
        dest: '{{ destination }}/{{ inventory_hostname }}/'
        mode: pull
      when: '{{ "_".join(item.split("_")[:-1]) in group_names }}'
      with_items: '{{ items.keys() | list }}'
